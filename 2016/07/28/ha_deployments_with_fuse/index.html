<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>HA Deployments With Fuse - Reagan&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Reagan&#039;s Blog"><meta name="msapplication-TileImage" content="/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Reagan&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="When out and about, I often get the question: “How do I setup HA (high availability) with Red Hat’s JBoss Fuse?”. People ask this question and they expect a simple, straightforward answer. And why sho"><meta property="og:type" content="blog"><meta property="og:title" content="HA Deployments With Fuse"><meta property="og:url" content="https://blog.joshdreagan.com/2016/07/28/ha_deployments_with_fuse/"><meta property="og:site_name" content="Reagan&#039;s Blog"><meta property="og:description" content="When out and about, I often get the question: “How do I setup HA (high availability) with Red Hat’s JBoss Fuse?”. People ask this question and they expect a simple, straightforward answer. And why sho"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://blog.joshdreagan.com/2016/07/28/ha_deployments_with_fuse/post-bg.jpg"><meta property="article:published_time" content="2016-07-29T03:34:04.000Z"><meta property="article:modified_time" content="2021-01-14T22:53:29.001Z"><meta property="article:author" content="Josh Reagan"><meta property="article:tag" content="activemq"><meta property="article:tag" content="amq"><meta property="article:tag" content="fuse"><meta property="article:tag" content="camel"><meta property="article:tag" content="cxf"><meta property="article:tag" content="karaf"><meta property="article:tag" content="jboss"><meta property="article:tag" content="wildfly"><meta property="article:tag" content="infinispan"><meta property="article:tag" content="datagrid"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/2016/07/28/ha_deployments_with_fuse/post-bg.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.joshdreagan.com/2016/07/28/ha_deployments_with_fuse/"},"headline":"Reagan's Blog","image":["https://blog.joshdreagan.com/2016/07/28/ha_deployments_with_fuse/post-bg.jpg"],"datePublished":"2016-07-29T03:34:04.000Z","dateModified":"2021-01-14T22:53:29.001Z","author":{"@type":"Person","name":"Josh Reagan"},"description":"When out and about, I often get the question: “How do I setup HA (high availability) with Red Hat’s JBoss Fuse?”. People ask this question and they expect a simple, straightforward answer. And why sho"}</script><link rel="canonical" href="https://blog.joshdreagan.com/2016/07/28/ha_deployments_with_fuse/"><link rel="alternate" href="/atom.xml" title="Reagan&#039;s Blog" type="application/atom+xml"><link rel="icon" href="/img/favicon.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-81075900-1" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'UA-81075900-1');</script><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><meta name="generator" content="Hexo 5.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="Reagan&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/tags">Tags</a></div><div class="navbar-end"><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><div class="card-image"><span class="image"><img class="fill" src="/2016/07/28/ha_deployments_with_fuse/post-bg.jpg" alt="HA Deployments With Fuse"></span></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2016-07-29T03:34:04.000Z" title="7/28/2016, 9:34:04 PM">2016-07-28</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-01-14T22:53:29.001Z" title="1/14/2021, 3:53:29 PM">2021-01-14</time></span></div></div><h1 class="title is-3 is-size-4-mobile">HA Deployments With Fuse</h1><div class="content"><p>When out and about, I often get the question: “How do I setup HA (high availability) with <a target="_blank" rel="noopener" href="http://developers.redhat.com/products/fuse/overview/">Red Hat’s JBoss Fuse</a>?”. People ask this question and they expect a simple, straightforward answer. And why shouldn’t they? The question is simple enough right? I could ask the same question about something like <a target="_blank" rel="noopener" href="http://tomcat.apache.org/">Tomcat</a> and get a well documented answer involving little more than a loadbalancer. Unfortunately, the answer for Fuse is a bit more involved and usually starts with the annoying response of “it depends”.</p>
<a id="more"></a>

<p>So let’s expand on that a bit… Considering my previous example of Tomcat (which is just a Servlet container), what protocol does it speak? Easy! It only talks 1 protocol… HTTP. But what protocol does Fuse speak? Well… since it’s an integration framework, the answer is several. It may be consuming from a REST service and placing the contents in files. Or maybe it’s accepting HL7 messages over TCP and dumping them onto JMS queues. And the way that you’d make a REST service HA is very different from the way that you’d make a file consumer HA (which is very different from the way you’d make a JMS broker HA, …). So you can see that while the answer of “it depends” might be a bit annoying, it is actually the most accurate answer I could give.</p>
<p>As of this writing, the <a target="_blank" rel="noopener" href="http://camel.apache.org/components.html">Camel Components</a> page lists 240 different components. And there’s no way I’m going to cover all of those in a blog post. So lets just focus on the one’s I run into most often.</p>
<h2 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h2><p>Many of the available Camel components speak HTTP. Among those would be <a target="_blank" rel="noopener" href="http://camel.apache.org/cxfrs.html">CXFRS</a> for REST services, <a target="_blank" rel="noopener" href="http://camel.apache.org/cxf.html">CXF</a> for SOAP services, and <a target="_blank" rel="noopener" href="http://camel.apache.org/jetty.html">Jetty</a> or <a target="_blank" rel="noopener" href="http://camel.apache.org/servlet.html">Servlet</a> for low level HTTP services. And because HTTP is so prolific, it is probably the most easily understood HA scenario we’ll cover.</p>
<p>With HTTP, there are two modes that we need to talk about (stateless, &amp; stateful).</p>
<p>Of the two, stateless is the most common and definitely the most recommended approach. It scales well, requires no coordination in a cluster, and is extremely easy to set up. You simply run however many instances you’d like of your service. The instances don’t have to know about eachother, and can be co-located or can be spread across datacenters. Once you have your services stood up, you simply place a loadbalancer (ie, <a target="_blank" rel="noopener" href="https://httpd.apache.org/">Apache HTTPd</a>, <a target="_blank" rel="noopener" href="https://www.nginx.com/">NGINX</a>, <a target="_blank" rel="noopener" href="http://www.haproxy.org/">HAProxy</a>, …) in front of them. There are even strategies that can be used to make the loadbalancers themselves HA (ie, hosting multiple instances with their own class A DNS records). So if any instance of your service goes down, the loadbalancer will simply redirect traffic to one of the other available instances. The client will send in his next request and have no idea that he isn’t talking to the same instance. Honestly, this topic has been covered so much that I don’t need to go into great detail about it. But here’s a very generic picture:</p>
<p><img src="http_stateless.png" alt="HTTP Stateless"></p>
<p>Stateful HTTP apps have fallen out of favor over the last decade or so. Which is a good thing in my opinion! They usually require some sort of session replication and/or coordination among the cluster. So now all of your instances need to know about eachother (limiting our ability to scale). And every time an object/value is placed in the session, it must be replicated to the other members (causing quite a bit of overhead that compounds as the cluster grows). We can mitigate some of these problems by being creative with our architecture. For instance, instead of having every member in the cluster connected in a mesh configuration we can split our servers into multiple meshes and do “sticky” loadbalancing to them. But it’s all a lot of hassle that you shouldn’t deal with if you can find a way to make your apps stateless instead. Once again, this is a topic that has been covered many times on the internet. The only thing specific to Fuse (and the only thing I’ll elaborate on in this blog) is setting up session replication for the Karaf container.</p>
<p>For the most part, if you’re running Camel on any JavaEE app server (and tying to its Servlet container), it will have its own mechanism for session replication. Most of the time, this is completely hidden away from you, and you get it for “free” just by setting up your servers in a cluster configuration. For instance, <a target="_blank" rel="noopener" href="http://developers.redhat.com/products/eap/overview/">JBoss EAP</a> uses an internal <a target="_blank" rel="noopener" href="http://infinispan.org/">Infinispan</a> cache to store its session data. If you run your EAP instances in “domain” mode, they will automatically be clustered and will replicate sessions accordingly. While you can override the cache settings and tweak them to fit your needs, you usually don’t have to mess with it. However, if you are running on a Karaf container, you’ll have to do a bit more of the setup yourself. This is because Karaf doesn’t assume that you’re using sessions, or even that you’re using Servlets. And if you do decide to use Servlets, it doesn’t assume which Servlet container you’ll use (ie, Tomcat, Jetty, …). So when you use any of the HTTP based components that I listed above on Karaf, they will (by default) fire up an embedded Jetty container. Luckily, Jetty is pluggable enough that it allows you to swap out its session management implementation. So you could, for instance, setup and configure Jetty to use an Infinispan cluster. Take a look at the <a target="_blank" rel="noopener" href="http://www.eclipse.org/jetty/documentation/jetty-9/index.html#session-management">Jetty Docs</a> for more details. In any case, the mechanism by which a session is handled is transparent to your application. So it’s really more of a configuration detail. And just to stay consistent, here’s another generic picture:</p>
<p><img src="http_stateful.png" alt="HTTP Stateful"></p>
<h2 id="HL7-MLLP"><a href="#HL7-MLLP" class="headerlink" title="HL7/MLLP"></a>HL7/MLLP</h2><p>HL7/MLLP is a TCP based protocol for the healthcare industry. Digging in a bit more, HL7 (Health Level Seven) is the definition of the format of the message (which can be text or XML based), and MLLP (Minimal Lower Layer Protocol) just defines a couple of bytes that wrap the message so we know where to start/stop when reading it in. Support for HL7v2 is provided via the <a target="_blank" rel="noopener" href="http://camel.apache.org/hl7.html">HL7</a> component in conjunction with a TCP transport component for doing the actual socket handling (ie, <a target="_blank" rel="noopener" href="http://camel.apache.org/mina2.html">Mina</a>, or <a target="_blank" rel="noopener" href="http://camel.apache.org/netty4.html">Netty</a>). There is some work being done on an <a target="_blank" rel="noopener" href="http://camel.apache.org/mllp.html">MLLP</a> component that will make it a bit simpler to work with, but as of this writing it’s still a bit early.</p>
<p>All of that said, regardless of the transport component that you choose, or whether you’re working with HL7v2 (text) or HL7v3 (XML), the interaction is stateless. That is to say that a client sends in a request message and synchronously receives an “ack/nack” response. That is the entire transaction. Any other interaction is a separate message/ack and is handled independently. So no server-side coordination is required by the message acceptors (see “<em>Note</em>“ below). And because no server-side coordination is required, you can just use any available TCP loadbalancer (similar to what we did with stateless HTTP above).</p>
<p><em>Note: You may have a requirement to resequence the messages and process them in order. In which case, you can take a look at my previous blog: <a href="/2016/05/27/ordered_messaging_with_activemq_and_camel/" title="Ordered Messaging With ActiveMQ &amp; Camel">Ordered Messaging With ActiveMQ &amp; Camel</a>.</em></p>
<p>Here’s a sample NGINX loadbalancer configuration that I used for a recent engagement:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">events &#123;</span><br><span class="line">  worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line">stream &#123;</span><br><span class="line">  server &#123;</span><br><span class="line">    listen 7000;</span><br><span class="line">    proxy_pass tcp_backend;</span><br><span class="line">  &#125;</span><br><span class="line">  upstream tcp_backend &#123;</span><br><span class="line">    server instance-1.local:7000;</span><br><span class="line">    server instance-2.local:7000;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>And here’s a (really simple) sample architecture:</p>
<p><img src="hl7_mllp.png" alt="HL7/MLLP"></p>
<h2 id="File-FTP"><a href="#File-FTP" class="headerlink" title="File/FTP"></a>File/FTP</h2><p>When consuming files using the <a target="_blank" rel="noopener" href="http://camel.apache.org/file2.html">File</a> or <a target="_blank" rel="noopener" href="http://camel.apache.org/ftp.html">FTP</a> components, there are a couple of different strategies that you can use for an HA setup: active/passive, and active/active.</p>
<p>In an active/passive configuration, you will have a single (master) instance polling for files. All of the other instances (slaves) will be waiting on some kind of lock. The slave instances will not begin polling for files until they detect that the master is no longer alive and well. In this way, we make sure that multiple JVMs running the same file poller config aren’t stepping on eachother’s toes while trying to consume the files. So how do we setup this active/passive coordination? If you’re using <a target="_blank" rel="noopener" href="http://fabric8.io/">Fabric8</a> <strong>v1.x</strong> to cluster your <a target="_blank" rel="noopener" href="http://karaf.apache.org/">Karaf</a> instances, you can just use the <a target="_blank" rel="noopener" href="http://fabric8.io/gitbook/camelEndpointMaster.html">Master</a> component. It exploits the fact that a Fabric cluster uses a <a target="_blank" rel="noopener" href="https://zookeeper.apache.org/">ZooKeeper</a> ensemble internally and uses it as a locking mechanism. Nice and simple! But what if you’re not running in a Fabric cluster? You could stand up your own ZooKeeper ensemble… But that adds a bit of overhead that you might not be ok with if you’re not using it for anything else. Does that mean that you’re out of luck? Heck no! Camel rocks! We can just create our own custom <a target="_blank" rel="noopener" href="http://camel.apache.org/routepolicy.html">RoutePolicy</a> to do the same thing. Here’s an example that I threw together for a customer recently: <a target="_blank" rel="noopener" href="https://github.com/joshdreagan/camel-singleton-policy">https://github.com/joshdreagan/camel-singleton-policy</a>.</p>
<p><img src="file_active-passive.png" alt="File Active/Passive"></p>
<p>Often times, you won’t need the highest possible performance when polling for files. That’s because the most common use case is that I receive a few files for batch processing <em>maybe</em> once a day. So I can probably handle the actual polling/processing on a single instance. And in that case, the active/passive configuration would be perfectly fine. But what if I’m not receiving batch files once a day? What if I’m processing satellite perturbation data (<strong>TONS</strong> of tiny files) coming in 24/7 in a neverending stream? Maybe now I want to take advantage of my entire cluster to poll/process in an active/active configuration. That way I can scale it up… Luckily, Camel makes this extremely easy. Because, again, Camel rocks! If you look at the available options for the file component, you’ll notice that it basically has an <a target="_blank" rel="noopener" href="http://camel.apache.org/idempotent-consumer.html">Idempotent Consumer</a> pattern baked right in (take a look at the <code>inProgressRepository</code> option). What’s more, it’s extremely flexible. It just needs any implementation of <code>org.apache.camel.spi.IdempotentRepository</code>. And there are already several implementations canned and ready to go. So you can use anything from Infinispan to a relational DB to coordinate your consumers. Here’s some sample code that uses Infinispan: <a target="_blank" rel="noopener" href="https://github.com/joshdreagan/clustered-file-consumer">https://github.com/joshdreagan/clustered-file-consumer</a>. Feel free to plagiarize!</p>
<p><img src="file_active-active.png" alt="File Active/Active"></p>
<h2 id="JMS-ActiveMQ"><a href="#JMS-ActiveMQ" class="headerlink" title="JMS (ActiveMQ)"></a>JMS (ActiveMQ)</h2><p>JMS (<a target="_blank" rel="noopener" href="http://activemq.apache.org/">ActiveMQ</a>) is definitely the most difficult HA scenario that I’ll cover. Which is why I procrastinated and saved it until the end. Well… sort of… When talking about JMS on Fuse, you have to specify whether you mean from a client’s perspective, or from the broker’s perspective.</p>
<p>HA from the client’s perspective is actually quite simple. You just use the <a target="_blank" rel="noopener" href="http://activemq.apache.org/failover-transport-reference.html">Failover</a> transport when creating your <code>javax.jms.ConnectionFactory</code> and the failover is handled for you. If a broker goes down, the client libraries will transparently reconnect to the next broker (whether it’s a slave, or another master) and keep on chugging with little more than a blip in performance. But let’s spend a little time and talk about the more complex case of making the broker itself HA.</p>
<p>When we say “make the broker HA”, what we really mean is “make the in-flight data that the broker is storing HA”. Because of the nature of messaging and it’s typical use case/requirements, this almost always ends up being a trade-off for performance vs reliability. So first let’s cover the easiest, best performing solution.</p>
<p>In a <a target="_blank" rel="noopener" href="http://activemq.apache.org/masterslave.html">Master/Slave</a> (active/passive) architecture, two or more brokers point to the same physical data store (typically <a target="_blank" rel="noopener" href="http://activemq.apache.org/kahadb.html">KahaDB</a>). Because the store can only be written to by one instance at a time, we must use some form of locking (similar to what we talked about in the File/FTP section). The lock implementation that ActiveMQ uses is pluggable. So you can specify your own custom ones. But there are defaults for each of the <a target="_blank" rel="noopener" href="http://activemq.apache.org/persistence.html">persistence adapters</a> and I rarely see customers override them.</p>
<p>Let me give a concrete example… When setting up ActiveMQ as a master/slave pair (<em>non-Fabric managed</em>) and using KahaDB, you would likely place the KahaDB storage directory on a shared filesystem (ie, NFSv4). Unless you customized the configuration, ActiveMQ would default to using an actual “lock” file. When the instances came up, they would both attempt to acquire a filesystem-level lock on that file. Whoever got there first would become master, would open up the KahaDB for read/write, and would open up any listeners to begin accepting client connections. Any other instances would fail to get the lock and would begin try-polling until they got it. And until then, they would not read/write the KahaDB, or accept client connections. So they’re passive…</p>
<p><img src="activemq_master-slave.png" alt="ActiveMQ Master/Slave"></p>
<p>This is the simplest setup, but does have some caveats. First, we’ll need to setup a shared filesystem that both instances can see. This will likely be something like an NFSv4 share. And because we need an actual filesystem-level lock, we must use a filesystem that supports them (<em>which is why I used the example of NFSv4 above and not NFSv3</em>). You’ll probably also want to make the storage that hosts your NFS shares HA as well. So you’ll likely use a SAN or some hardware appliance that provides this functionality. <em>If you do so, make sure that any data duplication/backup that occurs is <strong>fully synchronous</strong> and that filesystem-level locks are preserved during a failover!</em> Looking at you EMC… Next, because of the shared storage, high throughput, and file locking requirements, the master/slave instances must live in the same datacenter. I’ve seen many clients try to skirt this requirement and it always ends badly. However, if set up correctly this provides nearly immediate failover of in-flight messages within a datacenter as well as high message throughput. So if this satisfies your requirements, stop here.</p>
<p>So what if I have a requirement for HA across datacenters? Ok… let’s negotiate a little more. The simplest &amp; fastest solution is to use the master/slave setup outlined above, but also have a warm site setup in another DC. If you experience a full DC outage, you can manually migrate the storage hosting your KahaDB to the backup DC, configure an ActiveMQ instance to point to it, and bring it online. It doesn’t care where the KahaDB came from, or if it was previously owned by another instance. It will simply read in any messages that are currently stored and begin processing/delivering them to consumers. <em>If you do this, make sure to remember not to mount the storage up to the primary again when it comes back online or you will end up with duplicate messages.</em> Alternately, you can just wait until the downed DC comes back online. As long as there is no storage loss, all of your messages are safe and will be processed. So it really comes down to the SLA (Service-Level Agreement) that you must support, how likely you think a full DC outage is to occur, and how much manual interaction you’re ok with if it does.</p>
<p><img src="activemq_cross-dc.png" alt="ActiveMQ Cross-DC"></p>
<p>Well, what if I have to protect against a <em>real</em> DC outage? This is affectionately known in the defense industry as “the smoking-hole scenario”. That is to say, what if I can’t be guaranteed that I’ll be able to migrate storage during an outage because my DC is not simply <em>down</em>, but rather <em>destroyed</em>? Well first things first… Prepare to make some serious performance tradeoffs. <em>I cannot stress this enough! You will not be processing large sets of data while synchronously replicating across a WAN.</em></p>
<p>One solution that I’ve seen customers use is to replicate the storage using some sort of block-level disk replication software. <a target="_blank" rel="noopener" href="https://www.drbd.org/">DRBD</a> works well enough in this situation because it gives you a little bit of flexibility over performance vs absolute reliability (look at modes B or C in their docs (<strong>not A</strong>)). Basically, every write at the filesystem level is a blocking call. That call usually returns as soon as the data has been physically written to the disk. In the case of a block-level replication solution, that blocking call will not return until the data has been written to both the primary and the backup disks. Because this all occurs at the filesystem level, it is completely out of ActiveMQ’s hands. It just thinks it’s been given really slow storage. One thing to note here is that you would not set up an ActiveMQ Master/Slave pair using this technology because the filesystem-level locks would not replicate. So you would do the manual failover to the warm site as described above. The difference is that you won’t have to migrate the storage as it’s already been replicated safely to the backup DC.</p>
<p><img src="activemq_cross-dc_drbd.png" alt="ActiveMQ Cross-DC DRBD"></p>
<p>The second set of solutions that I’ve seen are a decent tick faster (still not blazing though), but add a bit complication to the clients. They’re both based on some variation of fanout/multicast. The basic gist of it is that the producer clients will send a copy of every message to a broker on both DCs. This isn’t that bad for the producers since the <a target="_blank" rel="noopener" href="http://activemq.apache.org/fanout-transport-reference.html">Fanout</a> transport handles all of the work for them. In fact, you can even toss in ActiveMQ’s <a target="_blank" rel="noopener" href="http://activemq.apache.org/the-proxy-connector.html">Proxy Connector</a> and the producer clients won’t have to change a bit.</p>
<p><img src="activemq_cross-dc_fanout.png" alt="ActiveMQ Cross-DC Fanout"></p>
<p>I know what you’re thinking… That doesn’t sound too bad. Where’s all this “complication” you were rambling on about? Don’t get too excited. We just haven’t gotten there yet. The added complication comes on the consumer/processing side. Basically, I now have duplicate messages that I’m processing. And I either have to prevent them using something like <a target="_blank" rel="noopener" href="http://camel.apache.org/idempotent-consumer.html">Idempotent Consumers</a> or embrace them by adding complication to my code.</p>
<p>The idempotent consumer strategy looks attractive because Camel makes it extremely easy. I just have to set up some sort of shared <code>org.apache.camel.spi.IdempotentRepository</code> and add a few lines of Camel routing to my <a target="_blank" rel="noopener" href="http://camel.apache.org/jms.html">JMS</a> consumers. Take a look at the <a target="_blank" rel="noopener" href="https://github.com/joshdreagan/clustered-amq-examples">https://github.com/joshdreagan/clustered-amq-examples</a> example <em>(specifically the “clustered-amq-examples-idempotent” module)</em> for more details. The problem is that I have to set up a repository that synchronously replicates its data across a WAN. So aren’t I back to the same exact problem I had before? Well… not quite. Definitely similar though. I’ll get a small performance boost since the producers are multicasting the message to both brokers in parallel (but blocking until they get back the configured minimum number of “acks”). And the synchronous replication that I mentioned is only an idempotent key (ie, the <code>JMSMessageID</code>) and not the entire message itself. Also, all instances are active. So I’m getting a bit more loadbalancing for my consumer clients. And they can failover faster than if I had a warm site setup (since I don’t have to perform a manual failover). That being said, don’t expect the performance to be stellar.</p>
<p>But what if I want my performance to be stellar? I told you you can’t have it! But we can possibly get a tiny bit better. The second option that I mentioned is to embrace the duplicates. Let’s expand on that. If I multicast/fanout a copy of every message to both brokers, I’m going to take that hit. If I want a fully synchronous, total data backup, there’s just no getting around it. But I don’t necessarily have to have my consumers coordinate. What if I just went ahead and processed the duplicates? Would the world end? Let’s use a concrete example. Let’s pretend that my consumers were accepting messages and placing each one into a relational DB. And let’s say that I might have some REST service that, when invoked with some ID, returns a record for that ID from that relational DB. If I inserted both copies of the message, my REST service would return two records. That’s not ideal! But what if it didn’t? What if I just had my REST service run a ever-so-slightly more complicated query that just returned the first record it found? I don’t care which one. They’re both the same. Now I’m back to the result that I wanted. And I have a pretty robust system that can handle duplicate records (both intentional and unintentional). Not too shabby! Now since you’re never satisfied, you might be asking about all of that duplicated data taking up extra space. Well that’s easy enough to fix… Simply have a “cleanup” job that runs at some predifined interval and removes any duplicates that it finds. I don’t care when it runs, or which record it ends up removing. My application will always return the correct result. Take a look at the <a target="_blank" rel="noopener" href="https://github.com/joshdreagan/clustered-amq-examples">https://github.com/joshdreagan/clustered-amq-examples</a> example <em>(specifically the “clustered-amq-examples-dupsok” module)</em> for more details.</p>
<p>So now you see why I saved JMS (ActiveMQ) HA to the very end. It’s a complicated subject with lots of possible solutions. Hopefully, one of them meets your needs. If not, there is just no pleasing you… Either way, this blog post has become way too wordy. So I’m calling it a day. :)</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>HA Deployments With Fuse</p><p><a href="https://blog.joshdreagan.com/2016/07/28/ha_deployments_with_fuse/">https://blog.joshdreagan.com/2016/07/28/ha_deployments_with_fuse/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Josh Reagan</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2016-07-28</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2021-01-14</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/activemq/">activemq</a><a class="link-muted mr-2" rel="tag" href="/tags/amq/">amq</a><a class="link-muted mr-2" rel="tag" href="/tags/fuse/">fuse</a><a class="link-muted mr-2" rel="tag" href="/tags/camel/">camel</a><a class="link-muted mr-2" rel="tag" href="/tags/cxf/">cxf</a><a class="link-muted mr-2" rel="tag" href="/tags/karaf/">karaf</a><a class="link-muted mr-2" rel="tag" href="/tags/jboss/">jboss</a><a class="link-muted mr-2" rel="tag" href="/tags/wildfly/">wildfly</a><a class="link-muted mr-2" rel="tag" href="/tags/infinispan/">infinispan</a><a class="link-muted mr-2" rel="tag" href="/tags/datagrid/">datagrid</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2016/08/22/decommissioning_jboss_a-mq_brokers/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Decommissioning JBoss A-MQ Brokers</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2016/05/27/ordered_messaging_with_activemq_and_camel/"><span class="level-item">Ordered Messaging With ActiveMQ &amp; Camel</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://www.gravatar.com/avatar/29313b56e332976a2383b911a27c15b2?s=128" alt="Josh Reagan"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Josh Reagan</p><p class="is-size-6 is-block">Software Engineer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Colorado, USA</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">26</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">20</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/joshdreagan" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/joshdreagan"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/joshdreagan"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="LinkedIn" href="https://www.linkedin.com/in/joshdreagan"><i class="fab fa-linkedin"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><figure class="media-left"><a class="image" href="/2025/06/19/bridging_apache_artemis_part_2/"><img src="/2025/06/19/bridging_apache_artemis_part_2/post-bg.jpg" alt="Bridging Apache Artemis - Part 2"></a></figure><div class="media-content"><p class="date"><time dateTime="2025-06-19T21:17:51.000Z">2025-06-19</time></p><p class="title"><a href="/2025/06/19/bridging_apache_artemis_part_2/">Bridging Apache Artemis - Part 2</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2020/03/20/dropping_dups_with_camel/"><img src="/2020/03/20/dropping_dups_with_camel/post-bg.jpg" alt="Dropping Dups With Camel"></a></figure><div class="media-content"><p class="date"><time dateTime="2020-03-20T20:57:20.000Z">2020-03-20</time></p><p class="title"><a href="/2020/03/20/dropping_dups_with_camel/">Dropping Dups With Camel</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2019/10/14/artemis_disaster_recovery/"><img src="/2019/10/14/artemis_disaster_recovery/post-bg.jpg" alt="Artemis Disaster Recovery"></a></figure><div class="media-content"><p class="date"><time dateTime="2019-10-15T04:55:40.000Z">2019-10-14</time></p><p class="title"><a href="/2019/10/14/artemis_disaster_recovery/">Artemis Disaster Recovery</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2019/05/30/streaming_in_the_cloud_with_camel_and_strimzi/"><img src="/2019/05/30/streaming_in_the_cloud_with_camel_and_strimzi/post-bg.jpg" alt="Streaming in the Cloud With Camel and Strimzi"></a></figure><div class="media-content"><p class="date"><time dateTime="2019-05-30T23:23:43.000Z">2019-05-30</time></p><p class="title"><a href="/2019/05/30/streaming_in_the_cloud_with_camel_and_strimzi/">Streaming in the Cloud With Camel and Strimzi</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2018/08/30/camel_aggregation_strategies/"><img src="/2018/08/30/camel_aggregation_strategies/post-bg.jpg" alt="Camel Aggregation Strategies"></a></figure><div class="media-content"><p class="date"><time dateTime="2018-08-31T04:43:34.000Z">2018-08-30</time></p><p class="title"><a href="/2018/08/30/camel_aggregation_strategies/">Camel Aggregation Strategies</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2025/06/"><span class="level-start"><span class="level-item">June 2025</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/03/"><span class="level-start"><span class="level-item">March 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/10/"><span class="level-start"><span class="level-item">October 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/05/"><span class="level-start"><span class="level-item">May 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/08/"><span class="level-start"><span class="level-item">August 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/03/"><span class="level-start"><span class="level-item">March 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/12/"><span class="level-start"><span class="level-item">December 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/08/"><span class="level-start"><span class="level-item">August 2017</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/03/"><span class="level-start"><span class="level-item">March 2017</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/01/"><span class="level-start"><span class="level-item">January 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/11/"><span class="level-start"><span class="level-item">November 2016</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/10/"><span class="level-start"><span class="level-item">October 2016</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/08/"><span class="level-start"><span class="level-item">August 2016</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/07/"><span class="level-start"><span class="level-item">July 2016</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/05/"><span class="level-start"><span class="level-item">May 2016</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/02/"><span class="level-start"><span class="level-item">February 2016</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/12/"><span class="level-start"><span class="level-item">December 2015</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/10/"><span class="level-start"><span class="level-item">October 2015</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/08/"><span class="level-start"><span class="level-item">August 2015</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/05/"><span class="level-start"><span class="level-item">May 2015</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/04/"><span class="level-start"><span class="level-item">April 2015</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/activemq/"><span class="tag">activemq</span><span class="tag">13</span></a></div><div class="control"><a class="tags has-addons" href="/tags/amq/"><span class="tag">amq</span><span class="tag">13</span></a></div><div class="control"><a class="tags has-addons" href="/tags/artemis/"><span class="tag">artemis</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/bpms/"><span class="tag">bpms</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/camel/"><span class="tag">camel</span><span class="tag">21</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cxf/"><span class="tag">cxf</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/datagrid/"><span class="tag">datagrid</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/fabric8/"><span class="tag">fabric8</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/feedhenry/"><span class="tag">feedhenry</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/fuse/"><span class="tag">fuse</span><span class="tag">20</span></a></div><div class="control"><a class="tags has-addons" href="/tags/infinispan/"><span class="tag">infinispan</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/jboss/"><span class="tag">jboss</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/jbpm/"><span class="tag">jbpm</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kafka/"><span class="tag">kafka</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/karaf/"><span class="tag">karaf</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/narayana/"><span class="tag">narayana</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/openshift/"><span class="tag">openshift</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/spring-boot/"><span class="tag">spring-boot</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/strimzi/"><span class="tag">strimzi</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/wildfly/"><span class="tag">wildfly</span><span class="tag">5</span></a></div></div></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="Reagan&#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2025 Josh Reagan</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>