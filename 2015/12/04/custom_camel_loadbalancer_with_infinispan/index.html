<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Custom Camel LoadBalancer With Infinispan - Reagan&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Reagan&#039;s Blog"><meta name="msapplication-TileImage" content="/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Reagan&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Apache Camel is a pretty full-featured EIP implementation framework. It has several existing strategies for load-balancing right out of the box. Round Robin, Random, Sticky, Weighted Round Robin, Weig"><meta property="og:type" content="blog"><meta property="og:title" content="Custom Camel LoadBalancer With Infinispan"><meta property="og:url" content="https://blog.joshdreagan.com/2015/12/04/custom_camel_loadbalancer_with_infinispan/"><meta property="og:site_name" content="Reagan&#039;s Blog"><meta property="og:description" content="Apache Camel is a pretty full-featured EIP implementation framework. It has several existing strategies for load-balancing right out of the box. Round Robin, Random, Sticky, Weighted Round Robin, Weig"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://blog.joshdreagan.com/2015/12/04/custom_camel_loadbalancer_with_infinispan/post-bg.png"><meta property="article:published_time" content="2015-12-04T07:00:00.000Z"><meta property="article:modified_time" content="2021-01-14T22:53:28.903Z"><meta property="article:author" content="Josh Reagan"><meta property="article:tag" content="fuse"><meta property="article:tag" content="camel"><meta property="article:tag" content="jboss"><meta property="article:tag" content="wildfly"><meta property="article:tag" content="infinispan"><meta property="article:tag" content="datagrid"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/2015/12/04/custom_camel_loadbalancer_with_infinispan/post-bg.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.joshdreagan.com/2015/12/04/custom_camel_loadbalancer_with_infinispan/"},"headline":"Reagan's Blog","image":["https://blog.joshdreagan.com/2015/12/04/custom_camel_loadbalancer_with_infinispan/post-bg.png"],"datePublished":"2015-12-04T07:00:00.000Z","dateModified":"2021-01-14T22:53:28.903Z","author":{"@type":"Person","name":"Josh Reagan"},"description":"Apache Camel is a pretty full-featured EIP implementation framework. It has several existing strategies for load-balancing right out of the box. Round Robin, Random, Sticky, Weighted Round Robin, Weig"}</script><link rel="canonical" href="https://blog.joshdreagan.com/2015/12/04/custom_camel_loadbalancer_with_infinispan/"><link rel="alternate" href="/atom.xml" title="Reagan&#039;s Blog" type="application/atom+xml"><link rel="icon" href="/img/favicon.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-81075900-1" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'UA-81075900-1');</script><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><meta name="generator" content="Hexo 5.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="Reagan&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/tags">Tags</a></div><div class="navbar-end"><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><div class="card-image"><span class="image"><img class="fill" src="/2015/12/04/custom_camel_loadbalancer_with_infinispan/post-bg.png" alt="Custom Camel LoadBalancer With Infinispan"></span></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2015-12-04T07:00:00.000Z" title="12/4/2015, 12:00:00 AM">2015-12-04</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-01-14T22:53:28.903Z" title="1/14/2021, 3:53:28 PM">2021-01-14</time></span></div></div><h1 class="title is-3 is-size-4-mobile">Custom Camel LoadBalancer With Infinispan</h1><div class="content"><p>Apache Camel is a pretty full-featured EIP implementation framework. It has several existing strategies for load-balancing right out of the box. Round Robin, Random, Sticky, Weighted Round Robin, Weighted Random,… the list goes on and on. But being that it’s a very well written and pluggable framework, it also gives you the ability to drop in your own custom strategies should you find that none of the existing ones meet your specific needs. So for this post, I created a custom Camel Load Balancer implementation utilizing an Infinispan cache to dynamically discover and load-balance between destination endpoints.</p>
<a id="more"></a>

<blockquote>
<p>The sample code for this post can be found at <a target="_blank" rel="noopener" href="https://github.com/joshdreagan/infinispan-discovery">https://github.com/joshdreagan/infinispan-discovery</a></p>
</blockquote>
<h2 id="Why"><a href="#Why" class="headerlink" title="Why?"></a>Why?</h2><p>Why would I do such a thing? Well… there’s a few good reasons.</p>
<p>First, all of the existing load-balancer strategies work on a static list. So if I know all of my endpoints ahead of time, no problem. I just code them into my Camel route. But what if my list of endpoints changes between environments? Maybe I could use properties. Well… only if the number of endpoints is static. Which brings me to the next reason…</p>
<p>All of the existing load-balancer strategies are configured at startup. So what do I do if my list changes dynamically at runtime? Let’s say that I want to do service discovery and load-balance between the currently active/registered backend services. If you’re familiar with Camel, you might be thinking “Why not just use the Camel Fabric Component? It does dynamic load-balancing and service discovery. Problem solved right?”. If all of my services are running in containers that are managed by Fabric8, that is a viable solution. But what if I want to discover some endpoints that are running on JBoss EAP instances. Or what if I’m not running a Fabric8 ensemble at all?</p>
<p>Finally, the most important reason… Because I can. :)</p>
<h2 id="Implementation-Details"><a href="#Implementation-Details" class="headerlink" title="Implementation Details"></a>Implementation Details</h2><p>Creating a custom Camel Load Balancer implementation is fairly straight forward. You just create a class and implement the <code>LoadBalancer</code> interface. There’s even a base class (<code>LoadBalancerSupport</code>) that you can extend that will take care of some of the boilerplate coding for you. You then just fill in the details of how it picks the next endpoint from its internal list. Pretty simple right?</p>
<p>In my case, however, I’m not actually coming up with my own strategy for how to pick endpoints. I’m really just augmenting some existing strategy with a dynamic list of endpoints. So to be more specific, I’m not interested in implementing my own flavor of the Random, Round Robin, Sticky, … strategies. No need to reinvent that wheel. Instead, I just want to decorate those existing strategies and provide them with some additional capabilities. So I use the decorator pattern. That allows me to ignore all the tom-foolery of the load-balancing itself and concentrate on the portion that I really want. The dynamic service discovery.</p>
<p>Here’s my custom load-balancer class (or at least the important parts):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.camel.processor.loadbalancer;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Import statements removed for brevity.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JCacheLoadBalancer</span> <span class="keyword">extends</span> <span class="title">ServiceSupport</span> <span class="keyword">implements</span> <span class="title">LoadBalancer</span>, <span class="title">CamelContextAware</span>, <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(JCacheLoadBalancer.class);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> LoadBalancer DEFAULT_DELEGATE = <span class="keyword">new</span> RoundRobinLoadBalancer();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Cache&lt;String, Set&lt;String&gt;&gt; registry;</span><br><span class="line">  <span class="keyword">private</span> String groupId;</span><br><span class="line">  <span class="keyword">private</span> LoadBalancer delegate;</span><br><span class="line">  <span class="keyword">private</span> UriPreProcessor uriPreProcessor;</span><br><span class="line">  <span class="keyword">private</span> Boolean throwExceptionIfEmpty;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Map&lt;String, Processor&gt; processorMap;</span><br><span class="line">  <span class="keyword">private</span> CacheEntryListenerConfiguration&lt;String, Set&lt;String&gt;&gt; registryListenerConfiguration;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> CamelContext camelContext;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Getters and setters removed for brevity.</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addProcessor</span><span class="params">(Processor processor)</span> </span>&#123;</span><br><span class="line">    delegate.addProcessor(processor);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeProcessor</span><span class="params">(Processor processor)</span> </span>&#123;</span><br><span class="line">    delegate.removeProcessor(processor);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> List&lt;Processor&gt; <span class="title">getProcessors</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> delegate.getProcessors();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Exchange exchange, AsyncCallback callback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((getProcessors() == <span class="keyword">null</span> || getProcessors().isEmpty()) &amp;&amp; throwExceptionIfEmpty) &#123;</span><br><span class="line">      <span class="keyword">if</span> (throwExceptionIfEmpty) &#123;</span><br><span class="line">        exchange.setException(<span class="keyword">new</span> LoadBalancerUnavailableException(String.format(<span class="string">&quot;No URIs found for service &#x27;%s&#x27;.&quot;</span>, groupId)));</span><br><span class="line">      &#125;</span><br><span class="line">      callback.done(<span class="keyword">true</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> delegate.process(exchange, callback);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Exchange exchange)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((getProcessors() == <span class="keyword">null</span> || getProcessors().isEmpty()) &amp;&amp; throwExceptionIfEmpty) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> LoadBalancerUnavailableException(String.format(<span class="string">&quot;No URIs found for service &#x27;%s&#x27;.&quot;</span>, groupId));</span><br><span class="line">    &#125;</span><br><span class="line">    delegate.process(exchange);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doStart</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (delegate == DEFAULT_DELEGATE) &#123;</span><br><span class="line">      ((Service) delegate).start();</span><br><span class="line">    &#125;</span><br><span class="line">    registry.registerCacheEntryListener(registryListenerConfiguration);</span><br><span class="line">    processUris(registry.get(groupId));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doStop</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    registry.deregisterCacheEntryListener(registryListenerConfiguration);</span><br><span class="line">    <span class="keyword">if</span> (delegate == DEFAULT_DELEGATE) &#123;</span><br><span class="line">      ((Service) delegate).stop();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Objects.requireNonNull(registry, <span class="string">&quot;The registry property must not be null.&quot;</span>);</span><br><span class="line">    Objects.requireNonNull(groupId, <span class="string">&quot;The groupId property must not be null.&quot;</span>);</span><br><span class="line">    Objects.requireNonNull(camelContext, <span class="string">&quot;The camelContext property must not be null.&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (delegate == <span class="keyword">null</span>) &#123;</span><br><span class="line">      delegate = DEFAULT_DELEGATE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (throwExceptionIfEmpty == <span class="keyword">null</span>) &#123;</span><br><span class="line">      throwExceptionIfEmpty = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    processorMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    registryListenerConfiguration = <span class="keyword">new</span> MutableCacheEntryListenerConfiguration&lt;&gt;(<span class="keyword">new</span> LookupCacheListenerFactory(), <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processUris</span><span class="params">(Set&lt;String&gt; uris)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (uris == <span class="keyword">null</span>) &#123;</span><br><span class="line">      uris = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (String uri : processorMap.keySet()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!uris.contains(uri)) &#123;</span><br><span class="line">        log.info(String.format(<span class="string">&quot;Removing uri: %s&quot;</span>, uri));</span><br><span class="line">        Processor processor = processorMap.remove(uri);</span><br><span class="line">        removeProcessor(processor);</span><br><span class="line">        <span class="keyword">if</span> (processor <span class="keyword">instanceof</span> Producer) &#123;</span><br><span class="line">          camelContext.removeEndpoint(((Producer) processor).getEndpoint());</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (String uri : uris) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!processorMap.containsKey(uri)) &#123;</span><br><span class="line">        log.info(String.format(<span class="string">&quot;Adding uri: %s&quot;</span>, uri));</span><br><span class="line">        String processedUri = uri;</span><br><span class="line">        <span class="keyword">if</span> (uriPreProcessor != <span class="keyword">null</span>) &#123;</span><br><span class="line">          processedUri = uriPreProcessor.process(uri);</span><br><span class="line">        &#125;</span><br><span class="line">        Processor processor = camelContext.getEndpoint(processedUri).createProducer();</span><br><span class="line">        processorMap.put(uri, processor);</span><br><span class="line">        addProcessor(processor);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">LookupCacheListener</span> <span class="keyword">implements</span> <span class="title">CacheEntryCreatedListener</span>&lt;<span class="title">String</span>, <span class="title">Set</span>&lt;<span class="title">String</span>&gt;&gt;,</span></span><br><span class="line"><span class="class">          <span class="title">CacheEntryUpdatedListener</span>&lt;<span class="title">String</span>, <span class="title">Set</span>&lt;<span class="title">String</span>&gt;&gt;,</span></span><br><span class="line"><span class="class">          <span class="title">CacheEntryRemovedListener</span>&lt;<span class="title">String</span>, <span class="title">Set</span>&lt;<span class="title">String</span>&gt;&gt;,</span></span><br><span class="line"><span class="class">          <span class="title">CacheEntryExpiredListener</span>&lt;<span class="title">String</span>, <span class="title">Set</span>&lt;<span class="title">String</span>&gt;&gt;,</span></span><br><span class="line"><span class="class">          <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// All listener methods removed for brevity. They just delegate to the onEvent method anyway.</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(Iterable&lt;CacheEntryEvent&lt;? extends String, ? extends Set&lt;String&gt;&gt;&gt; events)</span> <span class="keyword">throws</span> CacheEntryListenerException </span>&#123;</span><br><span class="line">      <span class="keyword">for</span> (CacheEntryEvent&lt;? extends String, ? extends Set&lt;String&gt;&gt; event : events) &#123;</span><br><span class="line">        log.debug(String.format(<span class="string">&quot;Got a cache event: %s&quot;</span>, event));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          processUris(event.getValue());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> CacheEntryListenerException(e);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">LookupCacheListenerFactory</span> <span class="keyword">implements</span> <span class="title">Factory</span>&lt;<span class="title">LookupCacheListener</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LookupCacheListener <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> LookupCacheListener();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>You can see that it’s just delegating most of the methods (ie, the <code>addProcessor</code>, <code>getProcessor</code>, and <code>removeProcessor</code> methods) to whatever existing implementation that it’s decorating. The actual methods that do the load-balancing (ie, the <code>process</code> methods) do a little bit of work, but end up just delegating as well. So I didn’t actually have to do any algorithm work and I still get to use all the existing strategies. Pretty neat!</p>
<p>In addition to a delegate <code>LoadBalancer</code> implementation, this class expects that you will give it a fully-configured jCache instance. In my example, I used Infinispan. But I could have just as easily used any other spec compliant implementation. Here’s my Infinispan configuration:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">infinispan</span> <span class="attr">xmlns</span>=<span class="string">&quot;...&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">jgroups</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">stack-file</span> <span class="attr">name</span>=<span class="string">&quot;external-file&quot;</span> <span class="attr">path</span>=<span class="string">&quot;default-configs/default-jgroups-tcp.xml&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">jgroups</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">cache-container</span> <span class="attr">default-cache</span>=<span class="string">&quot;default&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">local-cache</span> <span class="attr">name</span>=<span class="string">&quot;registry-cache&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transport</span> <span class="attr">cluster</span>=<span class="string">&quot;registry-cluster&quot;</span> <span class="attr">stack</span>=<span class="string">&quot;external-file&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">replicated-cache</span> <span class="attr">name</span>=<span class="string">&quot;registry-cache&quot;</span> <span class="attr">mode</span>=<span class="string">&quot;SYNC&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">cache-container</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">infinispan</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Now let’s get to the part that’s actually doing some work. The <code>LookupCacheListener</code> class just implements the various <code>CacheListener</code> interfaces from the jCache API. If it gets any events on the cache entry containing our endpoints, it simply updates the delegate’s internal list of processors. So as services come and go they can register their URIs in the cache, our listener will be notified, and our list of available load-balancer endpoints will be updated.</p>
<p>The final piece to discuss for this load-balancer implementation is the <code>UriPreProcessor</code>. This is an interface that I created to allow an implementation to customize the URI in some way before adding it to the list. The idea is that other services that are registering themselves might not know that they’re going to be invoked from a Camel endpoint. So they likely won’t add options like <code>bridgeEndpoint=true</code> to the URI. An implementation of this interface would allow you to add such options on their behalf. Here’s the interface itself:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.camel.processor.loadbalancer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UriPreProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">process</span><span class="params">(String uri)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>And here’s a sample implementation that adds the options:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.jboss.poc.greeter.camel;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Import statements removed for brevity.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GreeterServiceUriPreProcessor</span> <span class="keyword">implements</span> <span class="title">UriPreProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">process</span><span class="params">(String uri)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; options = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    options.put(<span class="string">&quot;bridgeEndpoint&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span> URISupport.appendParametersToURI(uri, options);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now all that’s left is to actually use it in my Camel routes. To do so, I declare it just like any other bean. Then I use the <code>custom</code> element in my <code>loadBalance</code> to <code>ref</code> it. Looks something like this:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;...&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;cachingProvider&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">&quot;javax.cache.Caching&quot;</span> <span class="attr">factory-method</span>=<span class="string">&quot;getCachingProvider&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;cacheManager&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">factory-bean</span>=<span class="string">&quot;cachingProvider&quot;</span> <span class="attr">factory-method</span>=<span class="string">&quot;getCacheManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">&quot;META-INF/infinispan/infinispan-clustered.xml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.util.ClassUtils&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">factory-method</span>=<span class="string">&quot;getDefaultClassLoader&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;registryCache&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">factory-bean</span>=<span class="string">&quot;cacheManager&quot;</span> <span class="attr">factory-method</span>=<span class="string">&quot;getCache&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">&quot;registry-cache&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;jCacheLoadBalancer&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">&quot;org.apache.camel.processor.loadbalancer.JCacheLoadBalancer&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">init-method</span>=<span class="string">&quot;start&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;stop&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;registry&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;registryCache&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;groupId&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">value</span>=<span class="string">&quot;/services/soap-http/&#123;http://poc.jboss.org/greeter&#125;GreeterService&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;delegate&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;randomLoadBalancer&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;uriPreProcessor&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;greeterServiceUriPreProcessor&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;greeterServiceUriPreProcessor&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">&quot;org.jboss.poc.greeter.camel.GreeterServiceUriPreProcessor&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;randomLoadBalancer&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">&quot;org.apache.camel.processor.loadbalancer.RandomLoadBalancer&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">camelContext</span> <span class="attr">id</span>=<span class="string">&quot;greeterGateway&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">trace</span>=<span class="string">&quot;false&quot;</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://camel.apache.org/schema/spring&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">route</span> <span class="attr">id</span>=<span class="string">&quot;proxyRoute&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">from</span> <span class="attr">uri</span>=<span class="string">&quot;jetty:http://localhost:9000/gateway/GreeterService?matchOnUriPrefix=true<span class="symbol">&amp;amp;</span>bridgeEndpoint=true&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">onException</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exception</span>&gt;</span>org.apache.camel.processor.loadbalancer.LoadBalancerUnavailableException<span class="tag">&lt;/<span class="name">exception</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">handled</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">constant</span>&gt;</span>true<span class="tag">&lt;/<span class="name">constant</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">handled</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setHeader</span> <span class="attr">headerName</span>=<span class="string">&quot;CamelHttpResponseCode&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">constant</span>&gt;</span>404<span class="tag">&lt;/<span class="name">constant</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">setHeader</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setBody</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">constant</span>&gt;</span>NOT FOUND<span class="tag">&lt;/<span class="name">constant</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">setBody</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">onException</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">loadBalance</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">custom</span> <span class="attr">ref</span>=<span class="string">&quot;jCacheLoadBalancer&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">loadBalance</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">route</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">camelContext</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>That’s it for the Camel side of things. Now let’s discuss how to get some services registered.</p>
<p>In my example, I just created a simple JAX-WS service in JBoss WildFly. Here’s the code so you can see how simple it is:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.jboss.poc.greeter.impl;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Import statements removed for brevity.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@WebService(endpointInterface = &quot;org.jboss.poc.greeter.Greeter&quot;,</span></span><br><span class="line"><span class="meta">            serviceName = &quot;GreeterService&quot;,</span></span><br><span class="line"><span class="meta">            portName = &quot;GreeterServicePort&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnglishGreeter</span> <span class="keyword">implements</span> <span class="title">Greeter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getGreeting</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    String greeting = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      greeting = String.format(<span class="string">&quot;Hello %s from %s!&quot;</span>, name, InetAddress.getLocalHost().getHostAddress());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      greeting = String.format(<span class="string">&quot;Hello %s! I was unable to find my IP :(...&quot;</span>, name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> greeting;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>For this service, I created a <code>ServletContextListener</code> to register/unregister it’s URI to/from the jCache.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.jboss.poc.greeter.impl;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Import statements removed for brevity.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@WebListener()</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GreeterServiceRegistrar</span> <span class="keyword">implements</span> <span class="title">ServletContextListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SERVICE_NAMESPACE = <span class="string">&quot;http://poc.jboss.org/greeter&quot;</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SERVICE_NAME = <span class="string">&quot;GreeterService&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGISTRY_CACHE_NAME = <span class="string">&quot;registry-cache&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(GreeterServiceRegistrar.class);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Inject</span></span><br><span class="line">  <span class="keyword">private</span> DefaultCacheManager cacheManager;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextInitialized</span><span class="params">(ServletContextEvent sce)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String key = getServiceKey();</span><br><span class="line">    <span class="keyword">final</span> String uri = getServiceURI(sce);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cacheManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">      log.info(String.format(<span class="string">&quot;Registering service: &#123;&#x27;%s&#x27;: &#x27;%s&#x27;&#125;&quot;</span>, key, uri));</span><br><span class="line"></span><br><span class="line">      Cache&lt;String, Set&lt;String&gt;&gt; cache = cacheManager.getCache(REGISTRY_CACHE_NAME);</span><br><span class="line">      Set&lt;String&gt; uris = cache.getOrDefault(key, <span class="keyword">new</span> HashSet&lt;String&gt;());</span><br><span class="line">      uris.add(uri);</span><br><span class="line">      cache.put(key, uris);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      log.warn(String.format(<span class="string">&quot;Unable to register service: &#123;&#x27;%s&#x27;: &#x27;%s&#x27;&#125;. CacheManager is null.&quot;</span>, key, uri));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextDestroyed</span><span class="params">(ServletContextEvent sce)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String key = getServiceKey();</span><br><span class="line">    <span class="keyword">final</span> String uri = getServiceURI(sce);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cacheManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">      log.info(String.format(<span class="string">&quot;Unregistering service: &#123;&#x27;%s&#x27;: &#x27;%s&#x27;&#125;&quot;</span>, key, uri));</span><br><span class="line">      Cache&lt;String, Set&lt;String&gt;&gt; cache = cacheManager.getCache(REGISTRY_CACHE_NAME);</span><br><span class="line">      Set&lt;String&gt; uris = cache.getOrDefault(key, <span class="keyword">new</span> HashSet&lt;String&gt;());</span><br><span class="line">      uris.remove(uri);</span><br><span class="line">      cache.put(key, uris);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      log.warn(String.format(<span class="string">&quot;Unable to unregister service: &#123;&#x27;%s&#x27;: &#x27;%s&#x27;&#125;. CacheManager is null.&quot;</span>, key, uri));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> String <span class="title">getServiceKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Contents removed for brevity. Method forms and returns the cache key where we&#x27;ll store our URIs.</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> String <span class="title">getServiceURI</span><span class="params">(ServletContextEvent sce)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Contents removed for brevity. Method grabs the current IP and port that the server is bound to and forms a URI.</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>So now when my <code>ServletContext</code> is started, my JAX-WS service URI will be registered. And when it is stopped, my URI will be removed. Since I configured my Infinispan cache the same on both the JBoss WildFly and Camel sides, the local cache instances are connected and will receive events and updates.</p>
<p>That’s it! If you want to give it a go, check out the full source code at <a target="_blank" rel="noopener" href="https://github.com/joshdreagan/infinispan-discovery">https://github.com/joshdreagan/infinispan-discovery</a>. Hopefully it’s useful…</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Custom Camel LoadBalancer With Infinispan</p><p><a href="https://blog.joshdreagan.com/2015/12/04/custom_camel_loadbalancer_with_infinispan/">https://blog.joshdreagan.com/2015/12/04/custom_camel_loadbalancer_with_infinispan/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Josh Reagan</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2015-12-04</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2021-01-14</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/fuse/">fuse</a><a class="link-muted mr-2" rel="tag" href="/tags/camel/">camel</a><a class="link-muted mr-2" rel="tag" href="/tags/jboss/">jboss</a><a class="link-muted mr-2" rel="tag" href="/tags/wildfly/">wildfly</a><a class="link-muted mr-2" rel="tag" href="/tags/infinispan/">infinispan</a><a class="link-muted mr-2" rel="tag" href="/tags/datagrid/">datagrid</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2016/02/02/amqp_performance_testing/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">AMQP Performance Testing With JBoss A-MQ</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2015/10/30/correcting_data_with_fuse_and_bpms/"><span class="level-item">Correcting Malformed Data With Fuse+BPMS</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://www.gravatar.com/avatar/29313b56e332976a2383b911a27c15b2?s=128" alt="Josh Reagan"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Josh Reagan</p><p class="is-size-6 is-block">Software Engineer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Colorado, USA</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">26</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">20</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/joshdreagan" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/joshdreagan"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/joshdreagan"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="LinkedIn" href="https://www.linkedin.com/in/joshdreagan"><i class="fab fa-linkedin"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><figure class="media-left"><a class="image" href="/2025/06/19/bridging_apache_artemis_part_2/"><img src="/2025/06/19/bridging_apache_artemis_part_2/post-bg.jpg" alt="Bridging Apache Artemis - Part 2"></a></figure><div class="media-content"><p class="date"><time dateTime="2025-06-19T21:17:51.000Z">2025-06-19</time></p><p class="title"><a href="/2025/06/19/bridging_apache_artemis_part_2/">Bridging Apache Artemis - Part 2</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2020/03/20/dropping_dups_with_camel/"><img src="/2020/03/20/dropping_dups_with_camel/post-bg.jpg" alt="Dropping Dups With Camel"></a></figure><div class="media-content"><p class="date"><time dateTime="2020-03-20T20:57:20.000Z">2020-03-20</time></p><p class="title"><a href="/2020/03/20/dropping_dups_with_camel/">Dropping Dups With Camel</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2019/10/14/artemis_disaster_recovery/"><img src="/2019/10/14/artemis_disaster_recovery/post-bg.jpg" alt="Artemis Disaster Recovery"></a></figure><div class="media-content"><p class="date"><time dateTime="2019-10-15T04:55:40.000Z">2019-10-14</time></p><p class="title"><a href="/2019/10/14/artemis_disaster_recovery/">Artemis Disaster Recovery</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2019/05/30/streaming_in_the_cloud_with_camel_and_strimzi/"><img src="/2019/05/30/streaming_in_the_cloud_with_camel_and_strimzi/post-bg.jpg" alt="Streaming in the Cloud With Camel and Strimzi"></a></figure><div class="media-content"><p class="date"><time dateTime="2019-05-30T23:23:43.000Z">2019-05-30</time></p><p class="title"><a href="/2019/05/30/streaming_in_the_cloud_with_camel_and_strimzi/">Streaming in the Cloud With Camel and Strimzi</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/2018/08/30/camel_aggregation_strategies/"><img src="/2018/08/30/camel_aggregation_strategies/post-bg.jpg" alt="Camel Aggregation Strategies"></a></figure><div class="media-content"><p class="date"><time dateTime="2018-08-31T04:43:34.000Z">2018-08-30</time></p><p class="title"><a href="/2018/08/30/camel_aggregation_strategies/">Camel Aggregation Strategies</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2025/06/"><span class="level-start"><span class="level-item">June 2025</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/03/"><span class="level-start"><span class="level-item">March 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/10/"><span class="level-start"><span class="level-item">October 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/05/"><span class="level-start"><span class="level-item">May 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/08/"><span class="level-start"><span class="level-item">August 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/03/"><span class="level-start"><span class="level-item">March 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/12/"><span class="level-start"><span class="level-item">December 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/08/"><span class="level-start"><span class="level-item">August 2017</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/03/"><span class="level-start"><span class="level-item">March 2017</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/01/"><span class="level-start"><span class="level-item">January 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/11/"><span class="level-start"><span class="level-item">November 2016</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/10/"><span class="level-start"><span class="level-item">October 2016</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/08/"><span class="level-start"><span class="level-item">August 2016</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/07/"><span class="level-start"><span class="level-item">July 2016</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/05/"><span class="level-start"><span class="level-item">May 2016</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/02/"><span class="level-start"><span class="level-item">February 2016</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/12/"><span class="level-start"><span class="level-item">December 2015</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/10/"><span class="level-start"><span class="level-item">October 2015</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/08/"><span class="level-start"><span class="level-item">August 2015</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/05/"><span class="level-start"><span class="level-item">May 2015</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/04/"><span class="level-start"><span class="level-item">April 2015</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/activemq/"><span class="tag">activemq</span><span class="tag">13</span></a></div><div class="control"><a class="tags has-addons" href="/tags/amq/"><span class="tag">amq</span><span class="tag">13</span></a></div><div class="control"><a class="tags has-addons" href="/tags/artemis/"><span class="tag">artemis</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/bpms/"><span class="tag">bpms</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/camel/"><span class="tag">camel</span><span class="tag">21</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cxf/"><span class="tag">cxf</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/datagrid/"><span class="tag">datagrid</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/fabric8/"><span class="tag">fabric8</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/feedhenry/"><span class="tag">feedhenry</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/fuse/"><span class="tag">fuse</span><span class="tag">20</span></a></div><div class="control"><a class="tags has-addons" href="/tags/infinispan/"><span class="tag">infinispan</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/jboss/"><span class="tag">jboss</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/jbpm/"><span class="tag">jbpm</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kafka/"><span class="tag">kafka</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/karaf/"><span class="tag">karaf</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/narayana/"><span class="tag">narayana</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/openshift/"><span class="tag">openshift</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/spring-boot/"><span class="tag">spring-boot</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/strimzi/"><span class="tag">strimzi</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/wildfly/"><span class="tag">wildfly</span><span class="tag">5</span></a></div></div></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="Reagan&#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2025 Josh Reagan</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>